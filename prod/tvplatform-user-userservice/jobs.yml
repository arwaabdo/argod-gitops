apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration-job
  annotations:
    argocd.argoproj.io/hook: PreSync  # Run this Job before any other resource
spec:
  template:
    spec:
      containers:
      - name: migration
        image: python:3.10-slim  # Replace with your desired Python version
        command: ["/bin/sh", "-c"]
        args:
          - |
            pip3 install pip --upgrade &&
            pip3 install poetry &&
            poetry install &&
            poetry run mypy . &&
            poetry run ruff check &&
            poetry run alembic upgrade head
        envFrom:
        - secretRef:
            name: tvplatform-user-userservice-prod  # Mount environment variables from the secret
      restartPolicy: Never  # Specify the restart policy
